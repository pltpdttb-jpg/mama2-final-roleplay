<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAMA Simulator (Text-First)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; touch-action: manipulation; }
        .recording-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .pyramid-level { transition: all 0.2s; cursor: pointer; position: relative; }
        .pyramid-selected { transform: scale(1.03); filter: brightness(1.1); box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10; border: 2px solid white; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .mic-btn-active { background-color: #ef4444 !important; transform: scale(1.1); }
    </style>
</head>
<body id="app" class="text-slate-800 bg-gray-50">

    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg overflow-hidden relative min-h-[750px] flex flex-col">
            
            <div class="bg-gradient-to-r from-blue-900 to-indigo-800 p-4 text-white relative flex items-center justify-between">
                <button v-if="step > 1 && step < 7" @click="prevStep" class="text-white/90 hover:text-white flex items-center text-sm bg-white/10 px-3 py-1.5 rounded-lg">
                    <i class="fa-solid fa-chevron-left mr-1"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                </button>
                <div v-else class="w-20"></div> <div class="text-center">
                    <h1 class="font-bold text-lg">MAMA Simulator</h1>
                    <span class="text-[10px] bg-white/20 px-2 py-0.5 rounded-full">Step {{ step }}/7</span>
                </div>
                
                <div class="w-20 text-right"></div> </div>
            
            <div class="h-1 bg-gray-100">
                <div class="h-full bg-green-500 transition-all duration-500" :style="{ width: (step / 7) * 100 + '%' }"></div>
            </div>

            <div class="p-6 flex-grow flex flex-col relative overflow-y-auto">
                
                <div v-if="isLoading" class="absolute inset-0 bg-white/95 z-50 flex flex-col items-center justify-center text-center p-6">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-600 mb-4"></div>
                    <p class="text-indigo-600 font-bold text-lg mb-2">{{ loadingTitle }}</p>
                    <p class="text-gray-500 text-sm">{{ loadingMessage }}</p>
                </div>

                <transition name="fade" mode="out-in">

                    <div v-if="step === 1" key="step1" class="space-y-4">
                        <h2 class="text-xl font-bold border-l-4 border-indigo-500 pl-3">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h2>
                        <div class="space-y-3">
                            <input v-model="form.empId" type="tel" class="w-full border p-3 rounded-lg bg-gray-50" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô">
                            <input v-model="form.name" type="text" class="w-full border p-3 rounded-lg bg-gray-50" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                            <div class="grid grid-cols-2 gap-3">
                                <select v-model="form.region" class="border p-3 rounded-lg bg-white"><option value="" disabled>Region</option><option v-for="r in regionList" :value="r">{{ r }}</option></select>
                                <select v-model="form.zone" :disabled="!form.region" class="border p-3 rounded-lg bg-white"><option value="" disabled>Zone</option><option v-for="z in filteredZones" :value="z.zone_name">{{ z.zone_name }}</option></select>
                            </div>
                        </div>
                        <button @click="nextStep" :disabled="!isFormValid" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold mt-4 shadow disabled:opacity-50">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    </div>

                    <div v-else-if="step === 2" key="step2" class="text-center pt-8 space-y-4">
                        <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto text-4xl shadow-inner">üëã</div>
                        <h2 class="text-2xl font-bold text-gray-800">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì {{ form.name }}</h2>
                        <div class="bg-blue-50 p-5 rounded-xl text-left border border-blue-100 text-sm space-y-2">
                            <h3 class="font-bold text-blue-800 border-b border-blue-200 pb-2 mb-2">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</h3>
                            <ul class="space-y-2 text-gray-700">
                                <li><i class="fa-solid fa-magnifying-glass mr-2 text-blue-500"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</li>
                                <li><i class="fa-solid fa-layer-group mr-2 text-blue-500"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Financial Pyramid</li>
                                <li><i class="fa-solid fa-microphone-lines mr-2 text-blue-500"></i> ‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á</li>
                            </ul>
                        </div>
                        <button @click="nextStep" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold mt-6 shadow hover:bg-indigo-700">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
                    </div>

                    <div v-else-if="step === 3" key="step3" class="space-y-4">
                        <h2 class="text-xl font-bold text-gray-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Fact Sheet)</h2>
                        <div v-if="currentScenario" class="bg-white border rounded-xl p-5 shadow-sm space-y-4">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center text-3xl border">
                                    {{ currentScenario.avatar_gender === 'male' ? 'üë®üèª‚Äçüíº' : 'üë©üèª‚Äçüíº' }}
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg">{{ currentScenario.name }} ({{ currentScenario.age }})</h3>
                                    <p class="text-sm text-gray-500">{{ currentScenario.job }}</p>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg text-sm space-y-2 border">
                                <div class="flex justify-between"><span>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ:</span><b>{{ currentScenario.financial_status.income }}</b></div>
                                <div class="flex justify-between"><span>‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°:</span><b>{{ currentScenario.financial_status.savings }}</b></div>
                                <div class="flex justify-between text-red-600"><span>‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô:</span><b>{{ currentScenario.financial_status.debt }}</b></div>
                            </div>
                            <div class="bg-red-50 p-3 rounded-lg border-l-4 border-red-500 text-sm">
                                <b class="text-red-800 block mb-1">Pain Point:</b> 
                                <span class="italic text-gray-700">"{{ currentScenario.pain_point }}"</span>
                            </div>
                        </div>
                        <button @click="nextStep" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold shadow">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </div>

                    <div v-else-if="step === 4" key="step4" class="text-center space-y-5">
                        <h2 class="text-xl font-bold text-gray-800">Financial Checkpoint</h2>
                        <p class="text-sm text-gray-500">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ê‡∏≤‡∏ô‡πÉ‡∏î?</p>
                        
                        <div class="flex flex-col items-center gap-1.5 py-4 select-none">
                            <div @click="form.quizAnswer='D'" :class="form.quizAnswer=='D'?'bg-indigo-600 pyramid-selected':'bg-indigo-300'" class="pyramid-level w-32 h-14 flex items-center justify-center text-white font-bold rounded-t-lg shadow-sm">Transfer</div>
                            <div @click="form.quizAnswer='C'" :class="form.quizAnswer=='C'?'bg-blue-600 pyramid-selected':'bg-blue-300'" class="pyramid-level w-48 h-12 flex items-center justify-center text-white font-bold shadow-sm">Accumulation</div>
                            <div @click="form.quizAnswer='B'" :class="form.quizAnswer=='B'?'bg-green-600 pyramid-selected':'bg-green-300'" class="pyramid-level w-64 h-12 flex items-center justify-center text-white font-bold shadow-sm">Protection</div>
                            <div @click="form.quizAnswer='A'" :class="form.quizAnswer=='A'?'bg-orange-500 pyramid-selected':'bg-orange-300'" class="pyramid-level w-80 h-12 flex items-center justify-center text-white font-bold rounded-b-lg shadow-sm">Creation</div>
                        </div>
                        
                        <button @click="nextStep" :disabled="!form.quizAnswer" class="w-full bg-green-600 text-white py-3.5 rounded-xl font-bold disabled:opacity-50 shadow">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
                    </div>

                    <div v-else-if="step === 5 || step === 6" :key="step" class="flex flex-col h-full">
                        <div class="mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Turn {{ step===5 ? '1: ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠' : '2: ‡∏Ç‡∏à‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á' }}</h2>
                            <div v-if="step===5" class="text-sm text-blue-600 mt-2 bg-blue-50 p-3 rounded-lg border border-blue-100">
                                üí° <b>Hint:</b> ‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î Gap ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "{{ currentScenario.pain_point }}"
                            </div>
                            <div v-else class="text-sm text-red-600 mt-2 bg-red-50 p-3 rounded-lg border-l-4 border-red-500 shadow-sm">
                                üó£Ô∏è <b>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏¢‡πâ‡∏á‡∏ß‡πà‡∏≤:</b> <br> <span class="italic">"{{ currentScenario.objection_text }}"</span>
                            </div>
                        </div>

                        <div class="flex-grow flex flex-col space-y-3">
                            <div class="relative flex-grow bg-white rounded-xl border-2 border-indigo-100 shadow-inner overflow-hidden">
                                <textarea v-model="currentText" 
                                    class="w-full h-full p-4 resize-none outline-none text-lg leading-relaxed text-gray-700" 
                                    :placeholder="isRecording ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...' : '‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡∏Ñ‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...'">
                                </textarea>
                                
                                <div v-if="isRecording" class="absolute inset-0 bg-white/90 flex flex-col items-center justify-center z-10 backdrop-blur-sm">
                                    <div class="w-16 h-16 bg-red-500 rounded-full recording-pulse mb-3 flex items-center justify-center text-white text-2xl">
                                        <i class="fa-solid fa-microphone-lines"></i>
                                    </div>
                                    <p class="text-red-500 font-bold animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á... (‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)</p>
                                    <button @click="stopDictation" class="mt-4 px-6 py-2 bg-gray-800 text-white rounded-full text-sm">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î</button>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-3">
                                <button @click="toggleDictation" 
                                    :class="isRecording ? 'bg-red-500 text-white ring-4 ring-red-200' : 'bg-indigo-600 text-white'"
                                    class="h-14 w-14 rounded-full flex items-center justify-center shadow-lg transition-all active:scale-95 flex-shrink-0">
                                    <i :class="isRecording ? 'fa-solid fa-stop' : 'fa-solid fa-microphone'" class="text-xl"></i>
                                </button>
                                <div class="text-xs text-gray-500">
                                    <span v-if="!isRecording">‡∏Å‡∏î‡πÑ‡∏°‡∏Ñ‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠ <b>"‡∏û‡∏π‡∏î‡πÅ‡∏ó‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå"</b><br>‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏á</span>
                                    <span v-else class="text-red-500 font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...</span>
                                </div>
                            </div>
                        </div>

                        <button @click="handleTurnSubmit" 
                            :disabled="!currentText || currentText.length < 5" 
                            class="w-full bg-gradient-to-r from-indigo-600 to-blue-600 text-white py-3.5 rounded-xl font-bold mt-4 shadow-lg disabled:opacity-50 disabled:shadow-none">
                            {{ step===5 ? '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠ (Turn 1)' : '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (Turn 2)' }}
                        </button>
                    </div>

                    <div v-else-if="step === 7" key="step7" class="text-center space-y-6 pt-4">
                        <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h2>
                            
                            <div class="relative w-40 h-40 mx-auto mb-6">
                                <svg class="w-full h-full transform -rotate-90">
                                    <circle cx="80" cy="80" r="70" stroke="#f3f4f6" stroke-width="12" fill="transparent"/>
                                    <circle cx="80" cy="80" r="70" :stroke="scoreColor" stroke-width="12" fill="transparent" :stroke-dasharray="circumference" :stroke-dashoffset="dashOffset" class="transition-all duration-1000 ease-out"/>
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <span class="text-5xl font-bold text-gray-800">{{ result.score }}</span>
                                    <span class="text-xs text-gray-400 uppercase tracking-widest mt-1">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</span>
                                </div>
                            </div>

                            <div class="text-left space-y-3">
                                <div class="p-3 bg-green-50 rounded-lg border-l-4 border-green-500">
                                    <h4 class="font-bold text-green-800 text-sm mb-1"><i class="fa-solid fa-thumbs-up mr-1"></i> ‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á</h4>
                                    <p class="text-sm text-green-700">{{ result.feedback.strength }}</p>
                                </div>
                                <div class="p-3 bg-amber-50 rounded-lg border-l-4 border-amber-500">
                                    <h4 class="font-bold text-amber-800 text-sm mb-1"><i class="fa-solid fa-lightbulb mr-1"></i> ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤</h4>
                                    <p class="text-sm text-amber-800">{{ result.feedback.weakness }}</p>
                                </div>
                            </div>
                        </div>
                        
                        <button @click="resetApp" class="w-full border-2 border-gray-300 text-gray-600 py-3.5 rounded-xl font-bold hover:bg-gray-50 transition-colors">
                            ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                        </button>
                    </div>

                </transition>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue
        const { createClient } = supabase

        // ==========================================
        // ‚öôÔ∏è CONFIGURATION
        // ==========================================
        const SUPABASE_URL = 'https://tjyiyzkfhspsetjzrpza.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRqeWl5emtmaHNwc2V0anpycHphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NTA1MDksImV4cCI6MjA4NjIyNjUwOX0.gURwQD6FIg2huu6HWQxO4I2QQwkh-DrjYu2fuMIEigw';
        const GEMINI_API_KEYS = [
            'AIzaSyDOPcBrKvf9diJhdJGPrbTW8rqwcVaQNZs', 
            'AIzaSyDOPcBrKvf9diJhdJGPrbTW8rqwcVaQNZs', 
            'AIzaSyDR276gb5fVkVTUp23rhHp5pM31ToRc4_U'
        ];

        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        createApp({
            setup() {
                // App State
                const step = ref(1);
                const isLoading = ref(false);
                const loadingTitle = ref('');
                const loadingMessage = ref('');
                
                // Data Model
                const form = ref({ empId: '', name: '', region: '', zone: '', quizAnswer: '' });
                const masterZones = ref([]);
                const currentScenario = ref(null);
                
                // Turn Data (Text-First)
                const textTurn1 = ref('');
                const textTurn2 = ref('');
                
                // Audio Recording (For Backup Evidence)
                const isRecording = ref(false); // UI State
                const audioChunks = ref([]);
                const recognition = ref(null);
                const mediaRecorder = ref(null); // For blob backup
                const audioBlobTurn1 = ref(null);
                const audioBlobTurn2 = ref(null);

                // --- Helper Functions ---
                const regionList = computed(() => [...new Set(masterZones.value.map(i => i.region))].sort());
                const filteredZones = computed(() => masterZones.value.filter(z => z.region === form.value.region));
                const isFormValid = computed(() => form.value.empId && form.value.name && form.value.region && form.value.zone);
                
                // Dynamic Text Binding
                const currentText = computed({
                    get: () => step.value === 5 ? textTurn1.value : textTurn2.value,
                    set: (val) => { if(step.value === 5) textTurn1.value = val; else textTurn2.value = val; }
                });

                // --- Initialization ---
                onMounted(async () => {
                    isLoading.value = true; loadingTitle.value = "Starting System...";
                    try {
                        const { data } = await _supabase.from('master_locations').select('*');
                        if(data) masterZones.value = data;
                        await fetchScenario();
                        initSpeechRecognition();
                    } catch(e) { console.error(e); } 
                    finally { isLoading.value = false; }
                });

                const fetchScenario = async () => {
                    const { data } = await _supabase.from('mama_scenarios').select('*');
                    if(data?.length) currentScenario.value = data[Math.floor(Math.random() * data.length)];
                };

                const initSpeechRecognition = () => {
                    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                        recognition.value = new SpeechRecognition();
                        recognition.value.lang = 'th-TH';
                        recognition.value.continuous = true;
                        recognition.value.interimResults = true;

                        recognition.value.onresult = (event) => {
                            let interimTranscript = '';
                            let finalTranscript = '';
                            
                            for (let i = event.resultIndex; i < event.results.length; ++i) {
                                if (event.results[i].isFinal) {
                                    finalTranscript += event.results[i][0].transcript;
                                } else {
                                    interimTranscript += event.results[i][0].transcript;
                                }
                            }
                            // Append text
                            if (finalTranscript) {
                                if(step.value === 5) textTurn1.value += ' ' + finalTranscript;
                                else textTurn2.value += ' ' + finalTranscript;
                            }
                        };
                        recognition.value.onerror = (e) => { 
                            console.error('Speech error', e); 
                            stopDictation();
                        };
                        recognition.value.onend = () => {
                            if (isRecording.value) {
                                // Restart if it stops unexpectedly but user hasn't clicked stop
                                // recognition.value.start(); 
                                isRecording.value = false; // Or just stop
                            }
                        };
                    } else {
                        alert("Browser ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ Chrome/Safari)");
                    }
                };

                // --- Navigation ---
                const nextStep = () => step.value++;
                const prevStep = () => step.value--;

                // --- Dictation Logic (Hybrid: Text + Audio Backup) ---
                const toggleDictation = async () => {
                    if (isRecording.value) {
                        stopDictation();
                    } else {
                        // Start Text Dictation
                        if (recognition.value) recognition.value.start();
                        
                        // Start Audio Backup Recording
                        try {
                            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                            let mime = MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : 'audio/webm';
                            mediaRecorder.value = new MediaRecorder(stream, { mimeType: mime });
                            const chunks = [];
                            mediaRecorder.value.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
                            mediaRecorder.value.onstop = () => {
                                const blob = new Blob(chunks, { type: mime });
                                if(step.value === 5) audioBlobTurn1.value = blob;
                                else audioBlobTurn2.value = blob;
                            };
                            mediaRecorder.value.start(1000);
                        } catch(e) { console.warn("Audio backup failed", e); }

                        isRecording.value = true;
                    }
                };

                const stopDictation = () => {
                    if (recognition.value) recognition.value.stop();
                    if (mediaRecorder.value) mediaRecorder.value.stop();
                    isRecording.value = false;
                };

                // --- Submission Logic ---
                const handleTurnSubmit = () => {
                    if (step.value === 5) {
                        stopDictation(); // Ensure recording stops
                        step.value = 6;
                    } else {
                        stopDictation();
                        submitFinal();
                    }
                };

                const result = ref({ score: 0, feedback: {} });
                const circumference = 2 * Math.PI * 70;
                const dashOffset = computed(() => circumference - (result.value.score / 100) * circumference);
                const scoreColor = computed(() => result.value.score >= 80 ? '#10b981' : result.value.score >= 50 ? '#f59e0b' : '#ef4444');

                const submitFinal = async () => {
                    isLoading.value = true;
                    loadingTitle.value = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•";
                    loadingMessage.value = "AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...";

                    try {
                        // 1. Upload Audio Evidence (Fire and Forget - don't wait strictly)
                        const ts = Date.now();
                        let url1 = null, url2 = null;
                        
                        const uploadAudio = async (blob, suffix) => {
                            if(!blob) return null;
                            const fname = `${ts}_${form.value.empId}_${suffix}.mp4`;
                            await _supabase.storage.from('mama-audio').upload(fname, blob);
                            return _supabase.storage.from('mama-audio').getPublicUrl(fname).data.publicUrl;
                        };

                        // Parallel Upload
                        const [u1, u2] = await Promise.all([
                            uploadAudio(audioBlobTurn1.value, 'turn1'),
                            uploadAudio(audioBlobTurn2.value, 'turn2')
                        ]);

                        // 2. Prepare Prompt for TEXT Analysis (Faster & More Reliable)
                        const prompt = `
                        System: You are a sales trainer. Evaluate this bank advisor role-play.
                        Scenario: Client ${currentScenario.value.name}, Pain: ${currentScenario.value.pain_point}, Objection: ${currentScenario.value.objection_text}.
                        
                        Advisor's Answer Turn 1 (Proposal): "${textTurn1.value}"
                        Advisor's Answer Turn 2 (Objection Handling): "${textTurn2.value}"
                        
                        Task:
                        1. Did Turn 1 address the Pain Point?
                        2. Did Turn 2 answer the objection politely?
                        
                        Output JSON (Thai): { "score": 0-100, "strength": "...", "weakness": "..." }
                        `;

                        // 3. Call AI
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEYS[0]}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });

                        const aiData = await res.json();
                        
                        if (!aiData.candidates) throw new Error("AI No Response");
                        const text = aiData.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                        const feedback = JSON.parse(text);

                        // Pyramid Score Adjustment
                        if(form.value.quizAnswer !== currentScenario.value.correct_pyramid_stage) {
                            feedback.score = Math.max(0, feedback.score - 10);
                            feedback.weakness += " (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Pyramid ‡∏ú‡∏¥‡∏î)";
                        }

                        result.value = { score: feedback.score, feedback };

                        // 4. Save to DB
                        await _supabase.from('mama_sessions').insert({
                            employee_id: form.value.empId, full_name: form.value.name, region: form.value.region, zone: form.value.zone,
                            scenario_id: currentScenario.value.id, user_pyramid_choice: form.value.quizAnswer,
                            text_content_turn1: textTurn1.value, 
                            text_content_turn2: textTurn2.value,
                            audio_url_turn1: u1, 
                            audio_url_turn2: u2,
                            ai_total_score: feedback.score, ai_feedback: feedback
                        });

                        step.value = 7;

                    } catch (err) {
                        console.error(err);
                        // Fallback: Save without score
                        await _supabase.from('mama_sessions').insert({
                            employee_id: form.value.empId, full_name: form.value.name, region: form.value.region, zone: form.value.zone,
                            scenario_id: currentScenario.value.id, user_pyramid_choice: form.value.quizAnswer,
                            text_content_turn1: textTurn1.value, text_content_turn2: textTurn2.value,
                            ai_total_score: 0, ai_feedback: { error: "AI Failed: " + err.message }
                        });
                        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÅ‡∏ï‡πà AI ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á) ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
                        step.value = 7;
                        result.value = { score: 0, feedback: { strength: "‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß", weakness: "‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á" } };
                    } finally {
                        isLoading.value = false;
                    }
                };

                const resetApp = async () => {
                    step.value = 1;
                    textTurn1.value = ''; textTurn2.value = '';
                    audioBlobTurn1.value = null; audioBlobTurn2.value = null;
                    await fetchScenario();
                };

                return {
                    step, form, regionList, filteredZones, isFormValid, currentScenario, isLoading, loadingTitle, loadingMessage,
                    isRecording, toggleDictation, stopDictation,
                    currentText, nextStep, prevStep, handleTurnSubmit, resetApp,
                    result, circumference, dashOffset, scoreColor
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
