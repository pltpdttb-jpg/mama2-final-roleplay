<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAMA Advisory Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; touch-action: manipulation; }
        .recording-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .pyramid-level { transition: all 0.2s; cursor: pointer; position: relative; }
        .pyramid-level:hover { filter: brightness(1.05); }
        .pyramid-selected { transform: scale(1.03); filter: brightness(1.1); box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10; border: 2px solid white; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        /* Tab Styles */
        .tab-btn { flex: 1; padding: 10px; text-align: center; cursor: pointer; font-weight: bold; color: #6b7280; border-bottom: 2px solid #e5e7eb; }
        .tab-active { color: #4f46e5; border-bottom: 2px solid #4f46e5; }
    </style>
</head>
<body id="app" class="text-slate-800 bg-gray-100">

    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg overflow-hidden relative min-h-[750px] flex flex-col">
            
            <div class="bg-gradient-to-r from-blue-900 to-indigo-800 p-4 text-white relative">
                <button v-if="step > 1 && step < 7" @click="prevStep" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white/80 hover:text-white">
                    <i class="fa-solid fa-chevron-left mr-1"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                </button>

                <div class="text-center">
                    <h1 class="font-bold text-lg">MAMA Simulator</h1>
                    <span class="text-xs bg-white/20 px-2 py-0.5 rounded">Step {{ step }}/7</span>
                </div>
            </div>
            <div class="h-1.5 bg-blue-950/10">
                <div class="h-full bg-green-500 transition-all duration-500" :style="{ width: (step / 7) * 100 + '%' }"></div>
            </div>

            <div class="p-6 flex-grow flex flex-col relative overflow-y-auto">
                <div v-if="isLoading" class="absolute inset-0 bg-white/95 z-50 flex flex-col items-center justify-center text-center p-6">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-600 mb-4"></div>
                    <p class="text-indigo-600 font-bold text-lg mb-2">{{ loadingTitle }}</p>
                    <p class="text-gray-500 text-sm">{{ loadingMessage }}</p>
                </div>

                <transition name="fade" mode="out-in">
                    
                    <div v-if="step === 1" key="step1" class="space-y-4">
                        <h2 class="text-xl font-bold border-l-4 border-indigo-500 pl-3">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h2>
                        <div class="space-y-3">
                            <input v-model="form.empId" type="tel" class="w-full border p-3 rounded-lg" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô">
                            <input v-model="form.name" type="text" class="w-full border p-3 rounded-lg" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                            <div class="grid grid-cols-2 gap-3">
                                <select v-model="form.region" class="border p-3 rounded-lg bg-white"><option value="" disabled>Region</option><option v-for="r in regionList" :value="r">{{ r }}</option></select>
                                <select v-model="form.zone" :disabled="!form.region" class="border p-3 rounded-lg bg-white"><option value="" disabled>Zone</option><option v-for="z in filteredZones" :value="z.zone_name">{{ z.zone_name }}</option></select>
                            </div>
                        </div>
                        <button @click="nextStep" :disabled="!isFormValid" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold mt-4 disabled:opacity-50">‡πÑ‡∏õ‡∏ï‡πà‡∏≠</button>
                    </div>

                    <div v-else-if="step === 2" key="step2" class="text-center pt-6 space-y-4">
                        <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto text-4xl">üëã</div>
                        <h2 class="text-2xl font-bold">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì {{ form.name }}</h2>
                        <div class="bg-slate-50 p-4 rounded-xl text-left border text-sm space-y-2">
                            <p><b>‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à:</b> Role Play ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>
                            <ul class="list-disc pl-5 text-gray-600">
                                <li>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</li>
                                <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Financial Pyramid</li>
                                <li>‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á</li>
                            </ul>
                        </div>
                        <button @click="nextStep" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold mt-4">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏¢</button>
                    </div>

                    <div v-else-if="step === 3" key="step3" class="space-y-4">
                        <h2 class="text-xl font-bold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
                        <div v-if="currentScenario" class="bg-white border rounded-xl p-5 shadow-sm space-y-3">
                            <div class="flex items-center gap-3">
                                <div class="text-4xl">{{ currentScenario.avatar_gender === 'male' ? 'üë®üèª‚Äçüíº' : 'üë©üèª‚Äçüíº' }}</div>
                                <div>
                                    <h3 class="font-bold">{{ currentScenario.name }} ({{ currentScenario.age }})</h3>
                                    <p class="text-sm text-gray-500">{{ currentScenario.job }}</p>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded text-sm space-y-1">
                                <div class="flex justify-between"><span>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ:</span><b>{{ currentScenario.financial_status.income }}</b></div>
                                <div class="flex justify-between"><span>‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°:</span><b>{{ currentScenario.financial_status.savings }}</b></div>
                                <div class="flex justify-between text-red-600"><span>‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô:</span><b>{{ currentScenario.financial_status.debt }}</b></div>
                            </div>
                            <div class="bg-red-50 p-3 rounded border-l-4 border-red-400 text-sm">
                                <b>Pain Point:</b> "{{ currentScenario.pain_point }}"
                            </div>
                        </div>
                        <button @click="nextStep" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
                    </div>

                    <div v-else-if="step === 4" key="step4" class="text-center space-y-4">
                        <h2 class="text-xl font-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Pyramid</h2>
                        <p class="text-sm text-gray-500">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ß‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ê‡∏≤‡∏ô‡πÉ‡∏î?</p>
                        <div class="flex flex-col items-center gap-1 py-4 select-none">
                            <div @click="form.quizAnswer='D'" :class="form.quizAnswer=='D'?'bg-indigo-600 pyramid-selected':'bg-indigo-300'" class="pyramid-level w-32 h-14 flex items-center justify-center text-white font-bold rounded-t-lg shadow">Transfer</div>
                            <div @click="form.quizAnswer='C'" :class="form.quizAnswer=='C'?'bg-blue-600 pyramid-selected':'bg-blue-300'" class="pyramid-level w-48 h-12 flex items-center justify-center text-white font-bold shadow">Accumulation</div>
                            <div @click="form.quizAnswer='B'" :class="form.quizAnswer=='B'?'bg-green-600 pyramid-selected':'bg-green-300'" class="pyramid-level w-64 h-12 flex items-center justify-center text-white font-bold shadow">Protection</div>
                            <div @click="form.quizAnswer='A'" :class="form.quizAnswer=='A'?'bg-orange-500 pyramid-selected':'bg-orange-300'" class="pyramid-level w-80 h-12 flex items-center justify-center text-white font-bold rounded-b-lg shadow">Creation</div>
                        </div>
                        <button @click="nextStep" :disabled="!form.quizAnswer" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold disabled:opacity-50">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                    </div>

                    <div v-else-if="step === 5 || step === 6" :key="step" class="flex flex-col h-full">
                        <div class="mb-4">
                            <h2 class="text-xl font-bold">Turn {{ step===5 ? '1: ‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠' : '2: ‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á' }}</h2>
                            <div v-if="step===5" class="text-sm text-blue-600 mt-2 bg-blue-50 p-2 rounded">üí° ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á: "{{ currentScenario.pain_point }}"</div>
                            <div v-else class="text-sm text-red-600 mt-2 bg-red-50 p-2 rounded border-l-4 border-red-500">üó£Ô∏è ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: "{{ currentScenario.objection_text }}"</div>
                        </div>

                        <div class="flex mb-4">
                            <div @click="inputType='audio'" :class="inputType=='audio' ? 'tab-active' : ''" class="tab-btn"><i class="fa-solid fa-microphone mr-1"></i> ‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</div>
                            <div @click="inputType='text'" :class="inputType=='text' ? 'tab-active' : ''" class="tab-btn"><i class="fa-solid fa-keyboard mr-1"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏≠‡∏ö</div>
                        </div>

                        <div v-if="inputType === 'audio'" class="flex-grow flex flex-col items-center justify-center space-y-4 py-6">
                            <button @mousedown="startRecording" @mouseup="stopRecording" @touchstart.prevent="startRecording" @touchend.prevent="stopRecording"
                                :class="isRecording ? 'bg-red-500 recording-pulse scale-110' : 'bg-indigo-600'"
                                class="w-20 h-20 rounded-full text-white shadow-xl flex items-center justify-center text-2xl transition-all">
                                <i :class="isRecording ? 'fa-solid fa-stop' : 'fa-solid fa-microphone'"></i>
                            </button>
                            <p class="text-sm text-gray-500">{{ isRecording ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : '‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î' }}</p>
                            
                            <div v-if="currentAudioUrl" class="w-full bg-gray-50 p-2 rounded border">
                                <audio :src="currentAudioUrl" controls class="w-full h-8"></audio>
                                <button @click="resetCurrentAudio" class="text-xs text-red-500 mt-1">‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà</button>
                            </div>
                        </div>

                        <div v-else class="flex-grow flex flex-col space-y-2">
                            <div class="relative flex-grow">
                                <textarea v-model="currentText" class="w-full h-40 p-3 border rounded-lg resize-none focus:ring-2 focus:ring-indigo-500" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                                <button @click="startDictation" class="absolute bottom-3 right-3 bg-gray-100 hover:bg-gray-200 text-gray-600 p-2 rounded-full shadow" title="‡∏û‡∏π‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå">
                                    <i class="fa-solid fa-microphone-lines"></i>
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 text-right">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡∏Ñ‡πå‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå (Speech-to-Text)</p>
                        </div>

                        <button @click="handleTurnSubmit" 
                            :disabled="(inputType=='audio' && !currentAudioBlob) || (inputType=='text' && !currentText)" 
                            class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold mt-auto disabled:opacity-50">
                            {{ step===5 ? '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•' }}
                        </button>
                    </div>

                    <div v-else-if="step === 7" key="step7" class="text-center space-y-6 pt-8">
                        
                        <div v-if="result.status === 'completed'">
                            <h2 class="text-2xl font-bold">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h2>
                            <div class="relative w-32 h-32 mx-auto">
                                <svg class="w-full h-full transform -rotate-90">
                                    <circle cx="64" cy="64" r="56" stroke="#e5e7eb" stroke-width="8" fill="transparent"/>
                                    <circle cx="64" cy="64" r="56" :stroke="scoreColor" stroke-width="8" fill="transparent" :stroke-dasharray="circumference" :stroke-dashoffset="dashOffset"/>
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <span class="text-3xl font-bold">{{ result.score }}</span>
                                </div>
                            </div>
                            <div class="text-left space-y-3 bg-white p-4 rounded-xl shadow-sm border">
                                <div><h4 class="font-bold text-green-700 text-sm">‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á</h4><p class="text-sm">{{ result.feedback.strength }}</p></div>
                                <hr>
                                <div><h4 class="font-bold text-amber-700 text-sm">‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤</h4><p class="text-sm">{{ result.feedback.weakness }}</p></div>
                            </div>
                        </div>

                        <div v-else>
                            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto text-4xl mb-4">
                                <i class="fa-solid fa-check"></i>
                            </div>
                            <h2 class="text-xl font-bold text-gray-800">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</h2>
                            <p class="text-gray-600">‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß</p>
                            <div class="bg-yellow-50 text-yellow-800 p-4 rounded-lg text-sm mt-4 border border-yellow-200">
                                <b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ‡∏£‡∏≠‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á (Manual Review)
                            </div>
                        </div>

                        <button @click="resetApp" class="w-full border-2 border-gray-300 py-3 rounded-lg font-bold text-gray-600 mt-8">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
                    </div>
                </transition>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue
        const { createClient } = supabase

        // CONFIG
        const SUPABASE_URL = 'https://tjyiyzkfhspsetjzrpza.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRqeWl5emtmaHNwc2V0anpycHphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NTA1MDksImV4cCI6MjA4NjIyNjUwOX0.gURwQD6FIg2huu6HWQxO4I2QQwkh-DrjYu2fuMIEigw';
        const GEMINI_API_KEYS = ['AIzaSyDOPcBrKvf9diJhdJGPrbTW8rqwcVaQNZs', 'AIzaSyDOPcBrKvf9diJhdJGPrbTW8rqwcVaQNZs', 'AIzaSyDR276gb5fVkVTUp23rhHp5pM31ToRc4_U'];
        
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        createApp({
            setup() {
                const step = ref(1);
                const isLoading = ref(false);
                const loadingTitle = ref('');
                const loadingMessage = ref('');
                
                // Data
                const form = ref({ empId: '', name: '', region: '', zone: '', quizAnswer: '' });
                const masterZones = ref([]);
                const currentScenario = ref(null);
                
                // Input Mode
                const inputType = ref('audio'); // 'audio' or 'text'
                const textTurn1 = ref('');
                const textTurn2 = ref('');
                
                // Audio
                const isRecording = ref(false);
                const audioBlob1 = ref(null); const audioUrl1 = ref(null);
                const audioBlob2 = ref(null); const audioUrl2 = ref(null);
                let mediaRecorder = null; let audioChunks = [];

                // Computed
                const regionList = computed(() => [...new Set(masterZones.value.map(i => i.region))].sort());
                const filteredZones = computed(() => masterZones.value.filter(z => z.region === form.value.region));
                const isFormValid = computed(() => form.value.empId && form.value.name && form.value.region && form.value.zone);
                
                const currentAudioBlob = computed(() => step.value === 5 ? audioBlob1.value : audioBlob2.value);
                const currentAudioUrl = computed(() => step.value === 5 ? audioUrl1.value : audioUrl2.value);
                
                // Computed for v-model binding with dynamic key
                const currentText = computed({
                    get: () => step.value === 5 ? textTurn1.value : textTurn2.value,
                    set: (val) => { if(step.value === 5) textTurn1.value = val; else textTurn2.value = val; }
                });

                // Init
                onMounted(async () => {
                    isLoading.value = true; loadingTitle.value = "Starting...";
                    try {
                        const { data } = await _supabase.from('master_locations').select('*');
                        if(data) masterZones.value = data;
                        await fetchScenario();
                    } catch(e) { console.error(e); } 
                    finally { isLoading.value = false; }
                });

                const fetchScenario = async () => {
                    const { data } = await _supabase.from('mama_scenarios').select('*');
                    if(data?.length) currentScenario.value = data[Math.floor(Math.random() * data.length)];
                };

                // --- Navigation ---
                const nextStep = () => step.value++;
                const prevStep = () => step.value--;

                // --- Audio Logic ---
                const startRecording = async () => {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        let mime = MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : 'audio/webm';
                        mediaRecorder = new MediaRecorder(stream, { mimeType: mime });
                        audioChunks = [];
                        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
                        mediaRecorder.onstop = () => {
                            const blob = new Blob(audioChunks, { type: mime });
                            const url = URL.createObjectURL(blob);
                            if(step.value === 5) { audioBlob1.value = blob; audioUrl1.value = url; }
                            else { audioBlob2.value = blob; audioUrl2.value = url; }
                        };
                        mediaRecorder.start(1000);
                        isRecording.value = true;
                    } catch { alert('Microphone access denied'); }
                };
                const stopRecording = () => { if(mediaRecorder && isRecording.value) { mediaRecorder.stop(); isRecording.value = false; } };
                const resetCurrentAudio = () => { if(step.value === 5) { audioBlob1.value=null; audioUrl1.value=null; } else { audioBlob2.value=null; audioUrl2.value=null; } };

                // --- Speech to Text (Web API) ---
                const startDictation = () => {
                    if (!('webkitSpeechRecognition' in window)) {
                        alert("Browser ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏û‡∏¥‡∏°‡∏û‡πå‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ Chrome)");
                        return;
                    }
                    const recognition = new webkitSpeechRecognition();
                    recognition.lang = 'th-TH';
                    recognition.interimResults = false;
                    recognition.maxAlternatives = 1;
                    
                    recognition.onstart = () => { isLoading.value = true; loadingTitle.value = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á..."; loadingMessage.value = "‡∏û‡∏π‡∏î‡πÉ‡∏™‡πà‡πÑ‡∏°‡∏Ñ‡πå‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢"; };
                    recognition.onend = () => { isLoading.value = false; };
                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        if(step.value === 5) textTurn1.value += " " + transcript;
                        else textTurn2.value += " " + transcript;
                    };
                    recognition.start();
                };

                // --- Submission & Fallback Logic ---
                const handleTurnSubmit = () => {
                    if(step.value === 5) {
                        step.value = 6; 
                        // Reset input type default to audio for next turn
                        // inputType.value = 'audio'; 
                    } else {
                        submitFinal();
                    }
                };

                const result = ref({ status: 'completed', score: 0, feedback: {} });
                const circumference = 2 * Math.PI * 56;
                const dashOffset = computed(() => circumference - (result.value.score / 100) * circumference);
                const scoreColor = computed(() => result.value.score >= 80 ? '#16a34a' : result.value.score >= 50 ? '#eab308' : '#dc2626');

                const submitFinal = async () => {
                    isLoading.value = true;
                    loadingTitle.value = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•";
                    loadingMessage.value = "AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...";

                    try {
                        const ts = Date.now();
                        let url1 = null, url2 = null;

                        // 1. Upload Audio (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                        if (audioBlob1.value) {
                            const f1 = `${ts}_${form.value.empId}_turn1.mp4`;
                            await _supabase.storage.from('mama-audio').upload(f1, audioBlob1.value);
                            url1 = _supabase.storage.from('mama-audio').getPublicUrl(f1).data.publicUrl;
                        }
                        if (audioBlob2.value) {
                            const f2 = `${ts}_${form.value.empId}_turn2.mp4`;
                            await _supabase.storage.from('mama-audio').upload(f2, audioBlob2.value);
                            url2 = _supabase.storage.from('mama-audio').getPublicUrl(f2).data.publicUrl;
                        }

                        // 2. Prepare AI Input
                        let aiContentParts = [{ text: `Scenario: Client ${currentScenario.value.name}, Pain: ${currentScenario.value.pain_point}, Objection: ${currentScenario.value.objection_text}. Task: Evaluate Turn 1 & Turn 2.` }];
                        
                        // ‡πÉ‡∏™‡πà Text ‡∏´‡∏£‡∏∑‡∏≠ Audio ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà User ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                        if (inputType.value === 'text') {
                            aiContentParts.push({ text: `Turn 1 Text: ${textTurn1.value}` });
                            aiContentParts.push({ text: `Turn 2 Text: ${textTurn2.value}` });
                        } else {
                            if(audioBlob1.value) {
                                const b64_1 = await new Promise(r => { const fr=new FileReader(); fr.onload=()=>r(fr.result.split(',')[1]); fr.readAsDataURL(audioBlob1.value); });
                                aiContentParts.push({ inline_data: { mime_type: "audio/mp4", data: b64_1 } });
                            }
                            if(audioBlob2.value) {
                                const b64_2 = await new Promise(r => { const fr=new FileReader(); fr.onload=()=>r(fr.result.split(',')[1]); fr.readAsDataURL(audioBlob2.value); });
                                aiContentParts.push({ inline_data: { mime_type: "audio/mp4", data: b64_2 } });
                            }
                        }

                        // 3. Call AI
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEYS[0]}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                contents: [{ parts: aiContentParts }],
                                safetySettings: [
                                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                                ]
                            })
                        });

                        const aiData = await res.json();
                        
                        // --- FALLBACK CHECK ---
                        if (!aiData.candidates || !aiData.candidates[0]) {
                            throw new Error("AI No Response"); // ‡πÇ‡∏¢‡∏ô Error ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤ catch
                        }
                        
                        // AI Success
                        const text = aiData.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                        const feedback = JSON.parse(text);
                        
                        result.value = { status: 'completed', score: feedback.score, feedback };

                        await _supabase.from('mama_sessions').insert({
                            employee_id: form.value.empId, full_name: form.value.name, region: form.value.region, zone: form.value.zone,
                            scenario_id: currentScenario.value.id, user_pyramid_choice: form.value.quizAnswer,
                            input_type: inputType.value,
                            audio_url_turn1: url1, audio_url_turn2: url2,
                            text_content_turn1: textTurn1.value, text_content_turn2: textTurn2.value,
                            ai_total_score: feedback.score, ai_feedback: feedback, review_status: 'completed'
                        });

                    } catch (err) {
                        console.error("AI Failed, using Fallback:", err);
                        
                        // --- FALLBACK EXECUTION ---
                        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á DB ‡πÅ‡∏ï‡πà‡πÉ‡∏™‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ 'pending_manual'
                        await _supabase.from('mama_sessions').insert({
                            employee_id: form.value.empId, full_name: form.value.name, region: form.value.region, zone: form.value.zone,
                            scenario_id: currentScenario.value.id, user_pyramid_choice: form.value.quizAnswer,
                            input_type: inputType.value,
                            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡πá‡πÄ‡∏Å‡πá‡∏ö ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô text ‡∏Å‡πá‡πÄ‡∏Å‡πá‡∏ö text
                            text_content_turn1: textTurn1.value, text_content_turn2: textTurn2.value,
                            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å AI Feedback ‡πÄ‡∏õ‡πá‡∏ô Error message
                            ai_total_score: 0, 
                            ai_feedback: { error: "AI Failed: " + err.message },
                            review_status: 'pending_manual'
                        });

                        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö "‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à"
                        result.value = { status: 'manual_review', score: 0, feedback: {} };
                    } finally {
                        isLoading.value = false;
                        step.value = 7;
                    }
                };

                const resetApp = async () => { 
                    step.value = 1; 
                    audioBlob1.value=null; audioBlob2.value=null;
                    textTurn1.value=''; textTurn2.value='';
                    await fetchScenario(); 
                };

                return { 
                    step, form, regionList, filteredZones, isFormValid, currentScenario, isLoading, loadingTitle, loadingMessage, 
                    isRecording, startRecording, stopRecording, currentAudioUrl, resetCurrentAudio,
                    inputType, currentText, startDictation,
                    handleTurnSubmit, nextStep, prevStep, resetApp, result, circumference, dashOffset, scoreColor, currentAudioBlob 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
