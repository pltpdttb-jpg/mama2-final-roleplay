<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAMA Advisory Simulator (Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; touch-action: manipulation; }
        .recording-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* Pyramid CSS */
        .pyramid-btn { transition: all 0.2s; clip-path: polygon(15% 0%, 85% 0%, 100% 100%, 0% 100%); margin-bottom: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .pyramid-top { clip-path: polygon(50% 0%, 0% 100%, 100% 100%); width: 120px; height: 80px; margin: 0 auto 4px auto; }
        .pyramid-layer { height: 60px; width: 100%; }
        .pyramid-selected { transform: scale(1.05); filter: brightness(1.2); box-shadow: 0 10px 15px rgba(0,0,0,0.2); z-index: 10; position: relative; }
    </style>
</head>
<body id="app" class="text-slate-800 bg-gray-100">

    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden relative min-h-[700px] flex flex-col">
            
            <div class="bg-gradient-to-r from-indigo-900 to-blue-800 p-6 text-white relative">
                <div class="flex justify-between items-start">
                    <div>
                        <h1 class="text-2xl font-bold tracking-wide">MAMA Simulator</h1>
                        <p class="text-indigo-200 text-xs uppercase tracking-wider">Role-Play Assessment</p>
                    </div>
                    <div class="text-right">
                        <span class="bg-white/20 px-2 py-1 rounded text-xs">Step {{ currentStepLabel }}</span>
                    </div>
                </div>
                <div class="mt-4 h-1.5 bg-indigo-900/50 rounded-full overflow-hidden">
                    <div class="h-full bg-green-400 transition-all duration-500 ease-out" :style="{ width: (step / 7) * 100 + '%' }"></div>
                </div>
            </div>

            <div class="p-6 flex-grow flex flex-col relative overflow-y-auto">
                
                <div v-if="isLoading" class="absolute inset-0 bg-white/95 z-50 flex flex-col items-center justify-center text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
                    <p class="text-indigo-600 font-semibold animate-pulse px-4">{{ loadingMessage }}</p>
                </div>

                <transition name="fade" mode="out-in">
                    
                    <div v-if="step === 1" key="step1" class="space-y-4">
                        <h2 class="text-xl font-bold text-gray-800 border-l-4 border-indigo-500 pl-3">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
                        <div class="space-y-3 pt-2">
                            <input v-model="form.empId" type="tel" class="w-full border rounded-lg p-3 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Numeric)">
                            <input v-model="form.name" type="text" class="w-full border rounded-lg p-3 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                            <div class="grid grid-cols-2 gap-3">
                                <select v-model="form.region" class="w-full border rounded-lg p-3 bg-white"><option value="" disabled>Region...</option><option v-for="r in regionList" :value="r">{{ r }}</option></select>
                                <select v-model="form.zone" :disabled="!form.region" class="w-full border rounded-lg p-3 bg-white"><option value="" disabled>Zone...</option><option v-for="z in filteredZones" :value="z.zone_name">{{ z.zone_name }}</option></select>
                            </div>
                        </div>
                        <button @click="nextStep" :disabled="!isFormValid" class="w-full mt-4 bg-indigo-600 text-white py-3.5 rounded-xl font-bold shadow-lg disabled:opacity-50">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    </div>

                    <div v-else-if="step === 2" key="step2" class="flex flex-col items-center text-center h-full pt-4">
                        <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center text-4xl mb-4">üëã</div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h2>
                        <p class="text-xl text-indigo-600 font-bold mb-6">‡∏Ñ‡∏∏‡∏ì {{ form.name }}</p>
                        
                        <div class="bg-slate-50 p-5 rounded-xl text-left w-full space-y-3 border border-slate-200 shadow-sm">
                            <h3 class="font-bold text-gray-700 border-b pb-2">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</h3>
                            <div class="flex items-start gap-3">
                                <span class="bg-blue-100 text-blue-700 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">1</span>
                                <p class="text-sm text-gray-600"><b>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</b> ‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πà (Financial Pyramid)</p>
                            </div>
                            <div class="flex items-start gap-3">
                                <span class="bg-blue-100 text-blue-700 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">2</span>
                                <p class="text-sm text-gray-600"><b>‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠ (Turn 1):</b> ‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢</p>
                            </div>
                            <div class="flex items-start gap-3">
                                <span class="bg-blue-100 text-blue-700 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">3</span>
                                <p class="text-sm text-gray-600"><b>‡∏Ç‡∏à‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á (Turn 2):</b> ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ L.E.A.P. ‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>
                            </div>
                        </div>

                        <button @click="nextStep" class="w-full mt-auto bg-green-600 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-green-700 animate-pulse">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
                    </div>

                    <div v-else-if="step === 3" key="step3" class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold text-gray-800">Mission: Fact Finding</h2>
                        </div>
                        <div v-if="currentScenario" class="bg-white border-2 border-indigo-50 rounded-xl p-5 shadow-sm relative">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center text-3xl shadow-inner border">
                                    {{ currentScenario.avatar_gender === 'male' ? 'üë®üèª‚Äçüíº' : 'üë©üèª‚Äçüíº' }}
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg text-gray-900">{{ currentScenario.name }} ({{ currentScenario.age }})</h3>
                                    <p class="text-sm text-gray-500">{{ currentScenario.job }}</p>
                                </div>
                            </div>
                            <div class="space-y-2 text-sm text-gray-700 bg-gray-50 p-3 rounded-lg">
                                <div class="flex justify-between"><span class="text-gray-500">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</span><span class="font-semibold">{{ currentScenario.financial_status.income }}</span></div>
                                <div class="flex justify-between"><span class="text-gray-500">‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°</span><span class="font-semibold">{{ currentScenario.financial_status.savings }}</span></div>
                                <div class="flex justify-between"><span class="text-gray-500">‡∏†‡∏≤‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ</span><span class="font-semibold text-red-600">{{ currentScenario.financial_status.debt }}</span></div>
                            </div>
                            <div class="mt-3 bg-red-50 p-3 rounded border-l-4 border-red-400">
                                <p class="text-red-700 font-bold text-xs uppercase mb-1">‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏±‡∏á‡∏ß‡∏• (Pain Point)</p>
                                <p class="italic text-gray-700">"{{ currentScenario.pain_point }}"</p>
                            </div>
                        </div>
                        <button @click="nextStep" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow transition-all">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• <i class="fa-solid fa-arrow-right"></i></button>
                    </div>

                    <div v-else-if="step === 4" key="step4" class="space-y-4 text-center">
                        <h2 class="text-xl font-bold text-gray-800">Checkpoint: ‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô</h2>
                        <p class="text-gray-600 text-sm mb-4">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ê‡∏≤‡∏ô‡πÉ‡∏î‡∏Ç‡∏≠‡∏á Financial Pyramid?</p>
                        
                        <div class="flex flex-col items-center justify-center py-4 select-none">
                            <div @click="form.quizAnswer = 'D'" :class="form.quizAnswer === 'D' ? 'bg-indigo-600 pyramid-selected' : 'bg-indigo-300'" class="pyramid-btn pyramid-top">
                                <span v-if="form.quizAnswer === 'D'"><i class="fa-solid fa-hand-holding-heart mr-1"></i> Transfer</span>
                                <span v-else>Transfer</span>
                            </div>
                            <div @click="form.quizAnswer = 'C'" :class="form.quizAnswer === 'C' ? 'bg-blue-600 pyramid-selected' : 'bg-blue-300'" class="pyramid-btn pyramid-layer" style="width: 180px;">
                                <span v-if="form.quizAnswer === 'C'"><i class="fa-solid fa-chart-line mr-1"></i> Accumulation</span>
                                <span v-else>Accumulation</span>
                            </div>
                            <div @click="form.quizAnswer = 'B'" :class="form.quizAnswer === 'B' ? 'bg-green-600 pyramid-selected' : 'bg-green-300'" class="pyramid-btn pyramid-layer" style="width: 240px;">
                                <span v-if="form.quizAnswer === 'B'"><i class="fa-solid fa-shield-halved mr-1"></i> Protection</span>
                                <span v-else>Protection</span>
                            </div>
                            <div @click="form.quizAnswer = 'A'" :class="form.quizAnswer === 'A' ? 'bg-orange-500 pyramid-selected' : 'bg-orange-300'" class="pyramid-btn pyramid-layer" style="width: 300px; clip-path: polygon(10% 0%, 90% 0%, 100% 100%, 0% 100%);">
                                <span v-if="form.quizAnswer === 'A'"><i class="fa-solid fa-coins mr-1"></i> Creation</span>
                                <span v-else>Creation</span>
                            </div>
                        </div>

                        <p v-if="form.quizAnswer" class="text-sm font-bold text-indigo-700 animate-fade-in-up">
                            ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: {{ getPyramidLabel(form.quizAnswer) }}
                        </p>

                        <button @click="nextStep" :disabled="!form.quizAnswer" class="w-full mt-4 bg-green-600 text-white py-3 rounded-xl font-bold disabled:opacity-50 transition-all">
                            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô & ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠
                        </button>
                    </div>

                    <div v-else-if="step === 5" key="step5" class="flex flex-col h-full items-center">
                        <div class="w-full text-left mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Turn 1: The Proposal</h2>
                            <p class="text-sm text-gray-500">‡∏û‡∏π‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î Gap (60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</p>
                        </div>
                        <div class="bg-blue-50 w-full p-4 rounded-lg border border-blue-200 mb-4 text-sm text-blue-800">
                            üí° <b>Hint:</b> ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏±‡∏á‡∏ß‡∏•‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "{{ currentScenario.pain_point }}"
                        </div>

                        <div class="flex-grow flex flex-col items-center justify-center space-y-4 w-full">
                            <button @mousedown="startRecording(1)" @mouseup="stopRecording(1)" @touchstart.prevent="startRecording(1)" @touchend.prevent="stopRecording(1)"
                                :class="isRecording ? 'bg-red-500 recording-pulse scale-110' : 'bg-indigo-600 hover:bg-indigo-700'"
                                class="w-24 h-24 rounded-full text-white shadow-2xl flex items-center justify-center transition-all select-none touch-none">
                                <i class="fa-solid fa-microphone text-3xl"></i>
                            </button>
                            <p class="text-sm font-medium text-gray-500">{{ isRecording ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Turn 1...' : '‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î' }}</p>
                        </div>

                        <div v-if="audioUrl1" class="w-full mt-2 animate-fade-in-up">
                            <audio :src="audioUrl1" controls class="w-full h-10 rounded-lg"></audio>
                            <button @click="resetAudio(1)" class="text-xs text-red-500 mt-1 hover:underline">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà</button>
                        </div>

                        <button @click="goToTurn2" :disabled="!audioBlob1" class="w-full mt-4 bg-indigo-600 text-white py-3.5 rounded-xl font-bold disabled:opacity-50 transition-all">
                            ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠ <i class="fa-solid fa-paper-plane ml-1"></i>
                        </button>
                    </div>

                    <div v-else-if="step === 6" key="step6" class="flex flex-col h-full items-center">
                        <div class="w-full text-left mb-2">
                            <h2 class="text-xl font-bold text-gray-800">Turn 2: Objection Handling</h2>
                            <span class="bg-red-100 text-red-800 px-2 py-0.5 rounded text-xs font-bold">‚ö†Ô∏è ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á!</span>
                        </div>

                        <div class="bg-white border-l-4 border-red-500 bg-red-50 p-4 rounded-r-xl shadow-sm mb-4 w-full mt-2">
                             <p class="text-gray-800 font-medium italic">"{{ currentScenario.objection_text }}"</p>
                        </div>
                        
                        <div class="flex-grow flex flex-col items-center justify-center space-y-4 w-full">
                            <button @mousedown="startRecording(2)" @mouseup="stopRecording(2)" @touchstart.prevent="startRecording(2)" @touchend.prevent="stopRecording(2)"
                                :class="isRecording ? 'bg-red-500 recording-pulse scale-110' : 'bg-purple-600 hover:bg-purple-700'"
                                class="w-24 h-24 rounded-full text-white shadow-2xl flex items-center justify-center transition-all select-none touch-none">
                                <i class="fa-solid fa-microphone-lines text-3xl"></i>
                            </button>
                            <p class="text-sm font-medium text-gray-500">{{ isRecording ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Turn 2...' : '‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ö' }}</p>
                        </div>

                        <div v-if="audioUrl2" class="w-full mt-2 animate-fade-in-up">
                            <audio :src="audioUrl2" controls class="w-full h-10 rounded-lg"></audio>
                            <button @click="resetAudio(2)" class="text-xs text-red-500 mt-1 hover:underline">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà</button>
                        </div>

                        <button @click="submitSimulation" :disabled="!audioBlob2" class="w-full mt-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3.5 rounded-xl font-bold shadow-lg hover:shadow-xl disabled:opacity-50 transition-all">
                            ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (Final Submit)
                        </button>
                    </div>

                    <div v-else-if="step === 7" key="step7" class="space-y-5 text-center">
                        <h2 class="text-2xl font-bold text-gray-800">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô Advisor</h2>
                        <div class="relative w-40 h-40 mx-auto">
                            <svg class="w-full h-full transform -rotate-90">
                                <circle cx="80" cy="80" r="70" stroke="#e5e7eb" stroke-width="10" fill="transparent"/>
                                <circle cx="80" cy="80" r="70" :stroke="scoreColor" stroke-width="10" fill="transparent" :stroke-dasharray="circumference" :stroke-dashoffset="dashOffset" class="transition-all duration-1000"/>
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span class="text-4xl font-bold text-gray-800">{{ result.score }}</span>
                                <span class="text-xs text-gray-500 uppercase font-bold">Total Score</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-3 text-left">
                            <div class="bg-green-50 p-4 rounded-xl border-l-4 border-green-500">
                                <h4 class="font-bold text-green-800 text-sm mb-1">‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á (Strength)</h4>
                                <p class="text-sm text-green-700 leading-snug">{{ result.feedback.strength }}</p>
                            </div>
                            <div class="bg-amber-50 p-4 rounded-xl border-l-4 border-amber-500">
                                <h4 class="font-bold text-amber-800 text-sm mb-1">‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤ (Improvement)</h4>
                                <p class="text-sm text-amber-800 leading-snug">{{ result.feedback.weakness }}</p>
                            </div>
                        </div>
                        <button @click="resetApp" class="w-full border-2 border-gray-200 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-50 transition-all">
                            <i class="fa-solid fa-rotate-right mr-1"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </div>
                </transition>
            </div>
        </div>
        <p class="mt-4 text-xs text-gray-400">Powered by Gemini 1.5 & Supabase</p>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue
        const { createClient } = supabase

        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://tjyiyzkfhspsetjzrpza.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRqeWl5emtmaHNwc2V0anpycHphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NTA1MDksImV4cCI6MjA4NjIyNjUwOX0.gURwQD6FIg2huu6HWQxO4I2QQwkh-DrjYu2fuMIEigw';
        const GEMINI_API_KEYS = [
            'AIzaSyDOPcBrKvf9diJhdJGPrbTW8rqwcVaQNZs', 
            'AIzaSyDOPcBrKvf9diJhdJGPrbTW8rqwcVaQNZs', 
            'AIzaSyDR276gb5fVkVTUp23rhHp5pM31ToRc4_U'
        ];
        
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        createApp({
            setup() {
                const step = ref(1);
                const isLoading = ref(false);
                const loadingMessage = ref('');
                const form = ref({ empId: '', name: '', region: '', zone: '', quizAnswer: '' });
                const masterZones = ref([]);
                const currentScenario = ref(null);
                
                // Audio
                const isRecording = ref(false);
                const audioBlob1 = ref(null);
                const audioBlob2 = ref(null);
                const audioUrl1 = ref(null);
                const audioUrl2 = ref(null);
                let mediaRecorder = null;
                let audioChunks = [];

                // --- Initial Load ---
                onMounted(async () => {
                    isLoading.value = true;
                    loadingMessage.value = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö...';
                    try {
                        const { data: zones } = await _supabase.from('master_locations').select('*');
                        if(zones) masterZones.value = zones;
                        await fetchRandomScenario();
                    } catch (e) {
                        console.error(e);
                    } finally {
                        isLoading.value = false;
                    }
                });

                const fetchRandomScenario = async () => {
                    const { data: scenarios } = await _supabase.from('mama_scenarios').select('*');
                    if (scenarios && scenarios.length > 0) {
                        currentScenario.value = scenarios[Math.floor(Math.random() * scenarios.length)];
                    }
                };

                // --- Helpers ---
                const regionList = computed(() => [...new Set(masterZones.value.map(i => i.region))].sort());
                const filteredZones = computed(() => masterZones.value.filter(z => z.region === form.value.region));
                const isFormValid = computed(() => form.value.empId && form.value.name && form.value.region && form.value.zone);
                const currentStepLabel = computed(() => step.value + '/7');
                
                const getPyramidLabel = (code) => {
                    const map = { 'A': 'Creation (‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á)', 'B': 'Protection (‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á)', 'C': 'Accumulation (‡∏™‡∏∞‡∏™‡∏°)', 'D': 'Transfer (‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠)' };
                    return map[code];
                };

                // --- Audio Logic ---
                const startRecording = async (turn) => {
                    try {
                        // iOS Safari often prefers mp4/aac, but generic blobs work if configured right.
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream); // Let browser decide mimeType
                        audioChunks = [];
                        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                        mediaRecorder.onstop = () => {
                            const blob = new Blob(audioChunks, { type: 'audio/mp4' }); // Use mp4 for iOS compatibility
                            const url = URL.createObjectURL(blob);
                            if(turn === 1) { audioBlob1.value = blob; audioUrl1.value = url; }
                            else { audioBlob2.value = blob; audioUrl2.value = url; }
                        };
                        mediaRecorder.start();
                        isRecording.value = true;
                    } catch (err) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô'); }
                };

                const stopRecording = (turn) => {
                    if (mediaRecorder && isRecording.value) {
                        mediaRecorder.stop();
                        isRecording.value = false;
                    }
                };

                const resetAudio = (turn) => {
                    if(turn === 1) { audioBlob1.value = null; audioUrl1.value = null; }
                    else { audioBlob2.value = null; audioUrl2.value = null; }
                };

                // --- AI Logic ---
                const blobToBase64 = (blob) => new Promise((resolve) => { 
                    const r = new FileReader(); 
                    r.onloadend = () => resolve(r.result.split(',')[1]); 
                    r.readAsDataURL(blob); 
                });

                let currentKeyIndex = 0;
                const callGemini = async (payload, attempt=0) => {
                    if(attempt >= GEMINI_API_KEYS.length) throw new Error("Server Busy");
                    const key = GEMINI_API_KEYS[currentKeyIndex];
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
                        });
                        if(res.status === 429) {
                            currentKeyIndex = (currentKeyIndex + 1) % GEMINI_API_KEYS.length;
                            return callGemini(payload, attempt+1);
                        }
                        return await res.json();
                    } catch(e) { return callGemini(payload, attempt+1); }
                };

                // Result State
                const result = ref({ score: 0, feedback: {} });
                const circumference = 2 * Math.PI * 70;
                const dashOffset = computed(() => circumference - (result.value.score / 100) * circumference);
                const scoreColor = computed(() => result.value.score >= 80 ? '#10b981' : result.value.score >= 50 ? '#f59e0b' : '#ef4444');

                const submitSimulation = async () => {
                    isLoading.value = true;
                    loadingMessage.value = 'AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á... (‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ 10-20 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)';

                    try {
                        // 1. Upload
                        const ts = Date.now();
                        const f1 = `${ts}_${form.value.empId}_turn1.mp4`;
                        const f2 = `${ts}_${form.value.empId}_turn2.mp4`;
                        await _supabase.storage.from('mama-audio').upload(f1, audioBlob1.value);
                        await _supabase.storage.from('mama-audio').upload(f2, audioBlob2.value);
                        const url1 = _supabase.storage.from('mama-audio').getPublicUrl(f1).data.publicUrl;
                        const url2 = _supabase.storage.from('mama-audio').getPublicUrl(f2).data.publicUrl;

                        // 2. AI Prompt
                        const b64_1 = await blobToBase64(audioBlob1.value);
                        const b64_2 = await blobToBase64(audioBlob2.value);

                        const systemPrompt = `
                            Role: Expert Sales Trainer.
                            Context: Bank Advisor role-play.
                            Scenario: Client "${currentScenario.value.name}" (Pain: ${currentScenario.value.pain_point}).
                            Correct Pyramid: ${currentScenario.value.correct_pyramid_stage}. User Selected: ${form.value.quizAnswer}.
                            Turn 2 Objection: "${currentScenario.value.objection_text}".

                            Task: Analyze 2 audio inputs.
                            Turn 1: Did they address the Pain Point?
                            Turn 2: Did they handle objection with Empathy (L.E.A.P)?

                            Output JSON:
                            { "score": (0-100), "strength": "Thai text", "weakness": "Thai text" }
                        `;

                        const payload = {
                            contents: [{ role: "user", parts: [
                                { text: systemPrompt },
                                { inline_data: { mime_type: "audio/mp4", data: b64_1 } },
                                { text: "Turn 2:" },
                                { inline_data: { mime_type: "audio/mp4", data: b64_2 } }
                            ]}],
                            generation_config: { response_mime_type: "application/json" }
                        };

                        const aiRes = await callGemini(payload);
                        
                        // ‚úÖ FIX: Check if candidates exist
                        if (!aiRes.candidates || !aiRes.candidates[0]) {
                            throw new Error("AI ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏î‡πâ (Safety Filter Blocked)");
                        }

                        let rawText = aiRes.candidates[0].content.parts[0].text;
                        rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                        const feedback = JSON.parse(rawText);

                        // Hard Logic adjustment
                        if(form.value.quizAnswer !== currentScenario.value.correct_pyramid_stage) {
                            feedback.score = Math.max(0, feedback.score - 10);
                            feedback.weakness += ` (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏µ‡∏£‡∏∞‡∏°‡∏¥‡∏î‡∏ú‡∏¥‡∏î ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô ${currentScenario.value.correct_pyramid_stage})`;
                        }

                        result.value = { score: feedback.score, feedback };

                        // 3. Save
                        await _supabase.from('mama_sessions').insert({
                            employee_id: form.value.empId, full_name: form.value.name, region: form.value.region, zone: form.value.zone,
                            scenario_id: currentScenario.value.id, user_pyramid_choice: form.value.quizAnswer,
                            audio_url_turn1: url1, audio_url_turn2: url2,
                            ai_total_score: feedback.score, ai_feedback: feedback, used_api_key_index: currentKeyIndex
                        });

                        step.value = 7;

                    } catch (err) {
                        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
                    } finally { isLoading.value = false; }
                };

                const nextStep = () => step.value++;
                const goToTurn2 = () => {
                    isLoading.value = true;
                    loadingMessage.value = '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤...';
                    setTimeout(() => { isLoading.value = false; step.value = 6; }, 1500);
                };
                const resetApp = async () => {
                    step.value = 1;
                    form.value.empId = ''; // Reset ID for new user
                    audioBlob1.value = null; audioBlob2.value = null;
                    audioUrl1.value = null; audioUrl2.value = null;
                    await fetchRandomScenario();
                };

                return {
                    step, form, regionList, filteredZones, isFormValid, currentScenario, currentStepLabel,
                    isRecording, startRecording, stopRecording, resetAudio, audioBlob1, audioBlob2, audioUrl1, audioUrl2,
                    submitSimulation, goToTurn2, nextStep, resetApp,
                    isLoading, loadingMessage,
                    result, circumference, dashOffset, scoreColor, getPyramidLabel
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
