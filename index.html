<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAMA Advisory Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; touch-action: manipulation; }
        .recording-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .pyramid-level { transition: all 0.2s; cursor: pointer; position: relative; }
        .pyramid-level:hover { filter: brightness(1.05); }
        .pyramid-selected { transform: scale(1.03); filter: brightness(1.1); box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10; border: 2px solid white; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body id="app" class="text-slate-800 bg-gray-100">

    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg overflow-hidden relative min-h-[700px] flex flex-col">
            
            <div class="bg-gradient-to-r from-blue-900 to-indigo-800 p-5 text-white">
                <div class="flex justify-between items-center">
                    <h1 class="font-bold text-lg"><i class="fa-solid fa-robot mr-2"></i>MAMA Simulator</h1>
                    <span class="text-xs bg-white/20 px-2 py-1 rounded">Step {{ step }}/7</span>
                </div>
                <div class="mt-3 h-1.5 bg-blue-950/30 rounded-full overflow-hidden">
                    <div class="h-full bg-green-400 transition-all duration-500" :style="{ width: (step / 7) * 100 + '%' }"></div>
                </div>
            </div>

            <div class="p-6 flex-grow flex flex-col relative overflow-y-auto">
                <div v-if="isLoading" class="absolute inset-0 bg-white/95 z-50 flex flex-col items-center justify-center text-center">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mb-4"></div>
                    <p class="text-indigo-600 font-semibold animate-pulse px-4">{{ loadingMessage }}</p>
                </div>

                <transition name="fade" mode="out-in">
                    
                    <div v-if="step === 1" key="step1" class="space-y-4">
                        <h2 class="text-xl font-bold border-l-4 border-indigo-500 pl-3">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
                        <div class="space-y-3">
                            <input v-model="form.empId" type="tel" class="w-full border p-3 rounded-lg" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)">
                            <input v-model="form.name" type="text" class="w-full border p-3 rounded-lg" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                            <select v-model="form.position" class="w-full border p-3 rounded-lg bg-white">
                                <option value="" disabled>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...</option>
                                <option v-for="p in ['CFSA','CISA','BM','WRM','IS','IA','Other']" :value="p">{{ p }}</option>
                            </select>
                            <div class="grid grid-cols-2 gap-3">
                                <select v-model="form.region" class="w-full border p-3 rounded-lg bg-white">
                                    <option value="" disabled>Region...</option>
                                    <option v-for="r in regionList" :value="r">{{ r }}</option>
                                </select>
                                <select v-model="form.zone" :disabled="!form.region" class="w-full border p-3 rounded-lg bg-white disabled:bg-gray-100">
                                    <option value="" disabled>Zone...</option>
                                    <option v-for="z in filteredZones" :value="z.zone_name">{{ z.zone_name }}</option>
                                </select>
                            </div>
                        </div>
                        <button @click="nextStep" :disabled="!isFormValid" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold mt-4 disabled:opacity-50">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    </div>

                    <div v-else-if="step === 2" key="step2" class="text-center pt-6 space-y-4">
                        <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto text-4xl">üëã</div>
                        <h2 class="text-2xl font-bold">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì {{ form.name }}</h2>
                        <div class="bg-slate-50 p-4 rounded-xl text-left border border-slate-200">
                            <h3 class="font-bold text-gray-700 mb-2 border-b pb-1">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</h3>
                            <ul class="space-y-2 text-sm text-gray-600">
                                <li>1. <b>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</b> ‡∏´‡∏≤ Gap ‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</li>
                                <li>2. <b>‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô:</b> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Financial Pyramid ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å</li>
                                <li>3. <b>Role Play:</b> ‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á</li>
                            </ul>
                        </div>
                        <button @click="nextStep" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold mt-4">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
                    </div>

                    <div v-else-if="step === 3" key="step3" class="space-y-4">
                        <h2 class="text-xl font-bold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Fact Finding)</h2>
                        <div v-if="currentScenario" class="bg-white border-2 border-indigo-50 rounded-xl p-5 shadow-sm">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center text-3xl">
                                    {{ currentScenario.avatar_gender === 'male' ? 'üë®üèª‚Äçüíº' : 'üë©üèª‚Äçüíº' }}
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg">{{ currentScenario.name }} ({{ currentScenario.age }})</h3>
                                    <p class="text-sm text-gray-500">{{ currentScenario.job }}</p>
                                </div>
                            </div>
                            <div class="space-y-2 text-sm bg-gray-50 p-3 rounded-lg">
                                <div class="flex justify-between"><span>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</span><b>{{ currentScenario.financial_status.income }}</b></div>
                                <div class="flex justify-between"><span>‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°</span><b>{{ currentScenario.financial_status.savings }}</b></div>
                                <div class="flex justify-between"><span>‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô</span><b class="text-red-600">{{ currentScenario.financial_status.debt }}</b></div>
                            </div>
                            <div class="mt-3 bg-red-50 p-3 rounded border-l-4 border-red-400">
                                <p class="text-xs text-red-700 font-bold uppercase">Pain Point</p>
                                <p class="italic">"{{ currentScenario.pain_point }}"</p>
                            </div>
                        </div>
                        <button @click="nextStep" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </div>

                    <div v-else-if="step === 4" key="step4" class="text-center space-y-4">
                        <h2 class="text-xl font-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô Financial Pyramid</h2>
                        <p class="text-sm text-gray-500">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ê‡∏≤‡∏ô‡πÉ‡∏î?</p>
                        
                        <div class="flex flex-col items-center gap-1 py-4 select-none">
                            <div @click="form.quizAnswer='D'" :class="form.quizAnswer=='D'?'bg-indigo-600 pyramid-selected':'bg-indigo-300'" class="pyramid-level w-32 h-16 flex items-center justify-center text-white font-bold rounded-t-lg shadow">Transfer</div>
                            <div @click="form.quizAnswer='C'" :class="form.quizAnswer=='C'?'bg-blue-600 pyramid-selected':'bg-blue-300'" class="pyramid-level w-48 h-12 flex items-center justify-center text-white font-bold shadow">Accumulation</div>
                            <div @click="form.quizAnswer='B'" :class="form.quizAnswer=='B'?'bg-green-600 pyramid-selected':'bg-green-300'" class="pyramid-level w-64 h-12 flex items-center justify-center text-white font-bold shadow">Protection</div>
                            <div @click="form.quizAnswer='A'" :class="form.quizAnswer=='A'?'bg-orange-500 pyramid-selected':'bg-orange-300'" class="pyramid-level w-80 h-12 flex items-center justify-center text-white font-bold rounded-b-lg shadow">Creation</div>
                        </div>
                        
                        <p v-if="form.quizAnswer" class="text-indigo-600 font-bold">‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: {{ form.quizAnswer }}</p>

                        <button @click="nextStep" :disabled="!form.quizAnswer" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold disabled:opacity-50">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô & ‡πÑ‡∏õ‡∏ï‡πà‡∏≠</button>
                    </div>

                    <div v-else-if="step === 5 || step === 6" :key="step" class="flex flex-col h-full items-center">
                        <div class="w-full text-left mb-2">
                            <h2 class="text-xl font-bold text-gray-800">Turn {{ step===5 ? '1: The Proposal' : '2: Objection' }}</h2>
                            <p class="text-sm text-gray-500">{{ step===5 ? '‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏õ‡∏¥‡∏î Gap' : '‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á‡∏î‡πâ‡∏ß‡∏¢ L.E.A.P.' }}</p>
                        </div>

                        <div v-if="step === 5" class="bg-blue-50 w-full p-4 rounded-lg border border-blue-200 mb-4 text-sm">
                            üí° <b>Hint:</b> ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏±‡∏á‡∏ß‡∏•‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "{{ currentScenario.pain_point }}"
                        </div>
                        <div v-else class="bg-red-50 w-full p-4 rounded-lg border-l-4 border-red-500 mb-4">
                             <p class="text-red-800 font-bold text-xs mb-1">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏π‡∏î‡∏ß‡πà‡∏≤:</p>
                             <p class="italic">"{{ currentScenario.objection_text }}"</p>
                        </div>

                        <div class="flex-grow flex flex-col items-center justify-center space-y-4">
                            <button @mousedown="startRecording" @mouseup="stopRecording" @touchstart.prevent="startRecording" @touchend.prevent="stopRecording"
                                :class="isRecording ? 'bg-red-500 recording-pulse scale-110' : (step===5?'bg-indigo-600':'bg-purple-600')"
                                class="w-24 h-24 rounded-full text-white shadow-2xl flex items-center justify-center transition-all select-none">
                                <i :class="step===5 ? 'fa-solid fa-microphone' : 'fa-solid fa-microphone-lines'" class="text-3xl"></i>
                            </button>
                            <p class="text-sm font-medium text-gray-500">{{ isRecording ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : '‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î' }}</p>
                        </div>

                        <div v-if="currentAudioUrl" class="w-full mt-2 bg-gray-50 p-2 rounded-lg border border-gray-200">
                            <div class="flex justify-between text-xs text-gray-500 mb-1">
                                <span>‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</span>
                                <button @click="resetCurrentAudio" class="text-red-500 hover:underline">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà</button>
                            </div>
                            <audio :src="currentAudioUrl" controls class="w-full h-8"></audio>
                        </div>

                        <button @click="handleTurnSubmit" :disabled="!currentAudioBlob" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold mt-4 disabled:opacity-50">
                            {{ step===5 ? '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠' : '‡∏™‡πà‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô' }}
                        </button>
                    </div>

                    <div v-else-if="step === 7" key="step7" class="text-center space-y-4">
                        <h2 class="text-2xl font-bold">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h2>
                        <div class="relative w-40 h-40 mx-auto">
                            <svg class="w-full h-full transform -rotate-90">
                                <circle cx="80" cy="80" r="70" stroke="#e5e7eb" stroke-width="10" fill="transparent"/>
                                <circle cx="80" cy="80" r="70" :stroke="scoreColor" stroke-width="10" fill="transparent" :stroke-dasharray="circumference" :stroke-dashoffset="dashOffset" class="transition-all duration-1000"/>
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span class="text-4xl font-bold">{{ result.score }}</span>
                                <span class="text-xs text-gray-500 font-bold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</span>
                            </div>
                        </div>
                        <div class="text-left space-y-2">
                            <div class="p-3 bg-green-50 border-l-4 border-green-500 rounded"><h4 class="font-bold text-green-800 text-sm">‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á</h4><p class="text-sm">{{ result.feedback.strength }}</p></div>
                            <div class="p-3 bg-amber-50 border-l-4 border-amber-500 rounded"><h4 class="font-bold text-amber-800 text-sm">‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤</h4><p class="text-sm">{{ result.feedback.weakness }}</p></div>
                        </div>
                        <button @click="resetApp" class="w-full border-2 border-gray-300 py-3 rounded-xl font-bold text-gray-600">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà</button>
                    </div>
                </transition>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue
        const { createClient } = supabase

        // ==========================================
        // ‚úÖ KEY ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á 100% ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        // ==========================================
        const SUPABASE_URL = 'https://tjyiyzkfhspsetjzrpza.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRqeWl5emtmaHNwc2V0anpycHphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NTA1MDksImV4cCI6MjA4NjIyNjUwOX0.gURwQD6FIg2huu6HWQxO4I2QQwkh-DrjYu2fuMIEigw';
        const GEMINI_API_KEYS = [
            'AIzaSyDOPcBrKvf9diJhdJGPrbTW8rqwcVaQNZs', 
            'AIzaSyDOPcBrKvf9diJhdJGPrbTW8rqwcVaQNZs', 
            'AIzaSyDR276gb5fVkVTUp23rhHp5pM31ToRc4_U'
        ];
        // ==========================================

        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        createApp({
            setup() {
                const step = ref(1);
                const isLoading = ref(false);
                const loadingMessage = ref('');
                const form = ref({ empId: '', name: '', position: '', region: '', zone: '', quizAnswer: '' });
                const masterZones = ref([]);
                const currentScenario = ref(null);
                
                // Audio
                const isRecording = ref(false);
                const audioBlob1 = ref(null); const audioUrl1 = ref(null);
                const audioBlob2 = ref(null); const audioUrl2 = ref(null);
                let mediaRecorder = null; let audioChunks = [];

                // Load Data
                onMounted(async () => {
                    isLoading.value = true; loadingMessage.value = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
                    try {
                        const { data } = await _supabase.from('master_locations').select('*');
                        if(data) masterZones.value = data;
                        await fetchScenario();
                    } catch(e) { console.error(e); } 
                    finally { isLoading.value = false; }
                });

                const fetchScenario = async () => {
                    const { data } = await _supabase.from('mama_scenarios').select('*');
                    if(data?.length) currentScenario.value = data[Math.floor(Math.random() * data.length)];
                };

                // Logic
                const regionList = computed(() => [...new Set(masterZones.value.map(i => i.region))].sort());
                const filteredZones = computed(() => masterZones.value.filter(z => z.region === form.value.region));
                const isFormValid = computed(() => form.value.empId && form.value.name && form.value.position && form.value.region && form.value.zone);
                
                const currentAudioBlob = computed(() => step.value === 5 ? audioBlob1.value : audioBlob2.value);
                const currentAudioUrl = computed(() => step.value === 5 ? audioUrl1.value : audioUrl2.value);

                // Audio Functions
                const startRecording = async () => {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream);
                        audioChunks = [];
                        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                        mediaRecorder.onstop = () => {
                            const blob = new Blob(audioChunks, { type: 'audio/mp4' }); // Use MP4 for iOS
                            const url = URL.createObjectURL(blob);
                            if(step.value === 5) { audioBlob1.value = blob; audioUrl1.value = url; }
                            else { audioBlob2.value = blob; audioUrl2.value = url; }
                        };
                        mediaRecorder.start(); isRecording.value = true;
                    } catch { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô'); }
                };

                const stopRecording = () => { if(mediaRecorder && isRecording.value) { mediaRecorder.stop(); isRecording.value = false; } };
                const resetCurrentAudio = () => { if(step.value === 5) { audioBlob1.value=null; audioUrl1.value=null; } else { audioBlob2.value=null; audioUrl2.value=null; } };

                // Submit Logic
                const handleTurnSubmit = () => {
                    if(step.value === 5) {
                        isLoading.value = true;
                        loadingMessage.value = '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤...';
                        setTimeout(() => { isLoading.value = false; step.value = 6; }, 1000);
                    } else {
                        submitFinal();
                    }
                };

                const result = ref({ score: 0, feedback: {} });
                const circumference = 2 * Math.PI * 70;
                const dashOffset = computed(() => circumference - (result.value.score / 100) * circumference);
                const scoreColor = computed(() => result.value.score >= 80 ? '#10b981' : result.value.score >= 50 ? '#f59e0b' : '#ef4444');

                const submitFinal = async () => {
                    isLoading.value = true; loadingMessage.value = 'AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏á‡∏≤‡∏ô...';
                    try {
                        // 1. Upload
                        const ts = Date.now();
                        const f1 = `${ts}_${form.value.empId}_turn1.mp4`;
                        const f2 = `${ts}_${form.value.empId}_turn2.mp4`;
                        await _supabase.storage.from('mama-audio').upload(f1, audioBlob1.value);
                        await _supabase.storage.from('mama-audio').upload(f2, audioBlob2.value);
                        const url1 = _supabase.storage.from('mama-audio').getPublicUrl(f1).data.publicUrl;
                        const url2 = _supabase.storage.from('mama-audio').getPublicUrl(f2).data.publicUrl;

                        // 2. AI
                        const b64_1 = await new Promise(r => { const fr=new FileReader(); fr.onload=()=>r(fr.result.split(',')[1]); fr.readAsDataURL(audioBlob1.value); });
                        const b64_2 = await new Promise(r => { const fr=new FileReader(); fr.onload=()=>r(fr.result.split(',')[1]); fr.readAsDataURL(audioBlob2.value); });

                        const prompt = `Role: Sales Trainer. Context: Bank Advisor Roleplay. Scenario: Client ${currentScenario.value.name}, Pain: ${currentScenario.value.pain_point}. Correct Pyramid: ${currentScenario.value.correct_pyramid_stage}. User Choice: ${form.value.quizAnswer}. Turn 2 Objection: ${currentScenario.value.objection_text}. Task: Analyze 2 audios. Did they address pain point? Did they handle objection? Output JSON: { "score": 0-100, "strength": "Thai text", "weakness": "Thai text" }`;

                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEYS[0]}`, {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: "audio/mp4", data: b64_1 } }, { inline_data: { mime_type: "audio/mp4", data: b64_2 } }] }] })
                        });
                        const aiData = await res.json();
                        // üõ°Ô∏è ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error ‡πÄ‡∏ß‡∏•‡∏≤ AI ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î format
                        if (!aiData.candidates || !aiData.candidates[0]) throw new Error("AI Busy/Filtered. Try again.");
                        const text = aiData.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                        const feedback = JSON.parse(text);

                        if(form.value.quizAnswer !== currentScenario.value.correct_pyramid_stage) feedback.score = Math.max(0, feedback.score - 10);
                        result.value = { score: feedback.score, feedback };

                        // 3. Save DB
                        await _supabase.from('mama_sessions').insert({
                            employee_id: form.value.empId, full_name: form.value.name, position: form.value.position, region: form.value.region, zone: form.value.zone,
                            scenario_id: currentScenario.value.id, user_pyramid_choice: form.value.quizAnswer,
                            audio_url_turn1: url1, audio_url_turn2: url2,
                            ai_total_score: feedback.score, ai_feedback: feedback
                        });
                        step.value = 7;
                    } catch(e) { 
                        console.error(e);
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• (‡∏•‡∏≠‡∏á‡∏Å‡∏î‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á): ' + e.message); 
                    } 
                    finally { isLoading.value = false; }
                };

                const nextStep = () => step.value++;
                const resetApp = async () => { step.value = 1; audioBlob1.value=null; audioBlob2.value=null; await fetchScenario(); };

                return { step, form, regionList, filteredZones, isFormValid, currentScenario, isLoading, loadingMessage, isRecording, startRecording, stopRecording, currentAudioUrl, resetCurrentAudio, handleTurnSubmit, nextStep, resetApp, result, circumference, dashOffset, scoreColor, currentAudioBlob };
            }
        }).mount('#app');
    </script>
</body>
</html>
